<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Mining Pool Dashboard - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #f7931a;
            text-shadow: 0 0 20px rgba(247, 147, 26, 0.3);
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .alert-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #dcfce7;
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            color: #fef3c7;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fecaca;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card h3 {
            color: #f7931a;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #4ade80;
            box-shadow: 0 0 8px #4ade80;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 8px #4ade80; }
            50% { box-shadow: 0 0 20px #4ade80; }
            100% { box-shadow: 0 0 8px #4ade80; }
        }
        
        .wide-card {
            grid-column: 1 / -1;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .miner-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .miner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .miner-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .hashrate-indicator {
            color: #10b981;
            font-weight: bold;
        }
        
        .low-efficiency {
            color: #f59e0b;
        }
        
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
        }
        
        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        
        .block-found {
            background: linear-gradient(45deg, #f59e0b, #f7931a);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            animation: blockFoundAnimation 3s ease-in-out;
        }
        
        @keyframes blockFoundAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .efficiency-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .efficiency-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .efficiency-high { background: #10b981; }
        .efficiency-medium { background: #f59e0b; }
        .efficiency-low { background: #ef4444; }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .performance-metric {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .time-windows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .time-window {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .window-label {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #f7931a;
        }

        .window-efficiency {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .window-shares {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Color coding for efficiency */
        .efficiency-excellent { color: #10b981; }  /* 95%+ */
        .efficiency-good { color: #f59e0b; }       /* 85-95% */
        .efficiency-poor { color: #ef4444; }       /* <85% */
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü™ô Bitcoin Mining Pool Dashboard</h1>
        <p>Real-time Solo Mining Operations Monitor</p>
    </div>
    
    <!-- Alert System -->
    <div id="alertContainer"></div>
    
    <!-- Main Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>üìä Pool Status</h3>
            <div class="stat-value">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="status">Loading...</span>
            </div>
            <div class="stat-subtext">Last updated: <span id="lastUpdate">-</span></div>
        </div>
        
        <div class="stat-card">
            <h3>‚õèÔ∏è Active Miners</h3>
            <div class="stat-value" id="totalMiners">0</div>
            <div class="stat-subtext">Connected workers</div>
        </div>
        
        <div class="stat-card">
            <h3>üìà Total Hashrate</h3>
            <div class="stat-value" id="totalHashrate">0 TH/s</div>
            <div class="stat-subtext">Combined mining power</div>
        </div>
        
        <div class="stat-card">
            <h3>üîÑ Shares Today</h3>
            <div class="stat-value" id="totalShares">0</div>
            <div class="stat-subtext"><span id="validShares">0</span> valid (<span id="efficiency">0%</span>)</div>
            <div class="efficiency-bar">
                <div class="efficiency-fill" id="efficiencyBar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>üéØ Network Info</h3>
            <div class="stat-value" id="blockHeight">0</div>
            <div class="stat-subtext">Current block height</div>
            <div style="font-size: 0.8rem; margin-top: 5px;">
                Difficulty: <span id="networkDifficulty">0</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>üíé Blocks Found</h3>
            <div class="stat-value" id="blocksFound">0</div>
            <div class="stat-subtext">Total blocks discovered</div>
            <div style="font-size: 0.8rem; margin-top: 5px;" id="lastBlockFound">
                Last: Never
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <!-- Time Window Performance Analysis -->
    <div class="stat-card wide-card">
        <h3>üìä Performance Analysis - Time Windows</h3>
        <div class="time-windows-grid">
            <div class="time-window">
                <div class="window-label">Last 30 Min</div>
                <div class="window-efficiency" id="efficiency30m">--%</div>
                <div class="window-shares"><span id="valid30m">0</span>/<span id="total30m">0</span></div>
            </div>
            <div class="time-window">
                <div class="window-label">Last 1 Hour</div>
                <div class="window-efficiency" id="efficiency1h">--%</div>
                <div class="window-shares"><span id="valid1h">0</span>/<span id="total1h">0</span></div>
            </div>
            <div class="time-window">
                <div class="window-label">Last 6 Hours</div>
                <div class="window-efficiency" id="efficiency6h">--%</div>
                <div class="window-shares"><span id="valid6h">0</span>/<span id="total6h">0</span></div>
            </div>
            <div class="time-window">
                <div class="window-label">Last 12 Hours</div>
                <div class="window-efficiency" id="efficiency12h">--%</div>
                <div class="window-shares"><span id="valid12h">0</span>/<span id="total12h">0</span></div>
            </div>
            <div class="time-window">
                <div class="window-label">Last 24 Hours</div>
                <div class="window-efficiency" id="efficiency24h">--%</div>
                <div class="window-shares"><span id="valid24h">0</span>/<span id="total24h">0</span></div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>üìä Hashrate Trend (24h)</h3>
            <canvas id="hashrateChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-card">
            <h3>üìà Share Distribution</h3>
            <canvas id="shareChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- Connected Miners Details -->
    <div class="stat-card wide-card">
        <h3>üë• Connected Miners</h3>
        <div id="minersList">Loading miners...</div>
    </div>
    
    <!-- Recent Activity Log -->
    <div class="stat-card wide-card">
        <h3>üìã Recent Activity</h3>
        <div class="activity-log" id="activityLog">
            <div class="activity-item">Loading recent activity...</div>
        </div>
    </div>

    <script>
        class MiningDashboard {
            constructor() {
                this.data = null;
                this.previousData = null;
                this.lastBlockCount = 0;
                this.hashrateHistory = [];
                this.shareHistory = [];
                this.alerts = [];
                
                this.initCharts();
                this.startUpdating();
            }
            
            async fetchStats() {
                try {
                    const response = await fetch('/api/realtime-stats');
                    if (!response.ok) throw new Error('Network error');
                    return await response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    this.showAlert('Connection error - unable to fetch stats', 'error');
                    return null;
                }
            }
            
            showAlert(message, type = 'info', duration = 5000) {
                const alertContainer = document.getElementById('alertContainer');
                const alertId = Date.now();
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.id = `alert-${alertId}`;
                alertDiv.innerHTML = `
                    <strong>${type.toUpperCase()}:</strong> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">√ó</button>
                `;
                
                alertContainer.appendChild(alertDiv);
                alertDiv.style.display = 'block';
                
                if (duration > 0) {
                    setTimeout(() => {
                        const alert = document.getElementById(`alert-${alertId}`);
                        if (alert) alert.remove();
                    }, duration);
                }
            }
            
            calculateHashrate(miners) {
                // Don't calculate here - use the exact value from the API
                console.log('Frontend: Using hashrate from API instead of calculating');
                return 0; // This will be overridden by API data
            }
            
            updateEfficiencyBar(efficiency) {
                const bar = document.getElementById('efficiencyBar');
                const numEfficiency = parseFloat(efficiency);
                
                bar.style.width = `${Math.min(numEfficiency, 100)}%`;
                
                if (numEfficiency >= 95) {
                    bar.className = 'efficiency-fill efficiency-high';
                } else if (numEfficiency >= 85) {
                    bar.className = 'efficiency-fill efficiency-medium';
                } else {
                    bar.className = 'efficiency-fill efficiency-low';
                }
            }
            
            detectAnomalies(data) {
                if (!this.previousData) return;
                
                const prev = this.previousData.stats;
                const curr = data.stats;
                
                // Check for efficiency drops
                if (parseFloat(curr.efficiency) < parseFloat(prev.efficiency) - 10) {
                    this.showAlert(`Efficiency dropped from ${prev.efficiency}% to ${curr.efficiency}%`, 'warning');
                }
                
                // Check for disconnected miners
                if (curr.totalMiners < prev.totalMiners) {
                    this.showAlert(`${prev.totalMiners - curr.totalMiners} miner(s) disconnected`, 'warning');
                }
                
                // Check for new blocks
                if (curr.blocksFound > this.lastBlockCount) {
                    this.showAlert(`üéâ BLOCK FOUND! Total blocks: ${curr.blocksFound}`, 'success', 10000);
                    this.lastBlockCount = curr.blocksFound;
                }
            }
            
            updateDashboard(data) {
                if (!data) {
                    document.getElementById('status').textContent = 'Offline';
                    document.getElementById('statusIndicator').className = 'status-indicator status-offline';
                    return;
                }
                
                this.detectAnomalies(data);
                
                const stats = data.stats;
                
                // Update main stats
                document.getElementById('totalMiners').textContent = stats.totalMiners;
                document.getElementById('totalShares').textContent = stats.totalShares.toLocaleString();
                document.getElementById('validShares').textContent = stats.validShares.toLocaleString();
                document.getElementById('efficiency').textContent = stats.efficiency + '%';
                document.getElementById('blocksFound').textContent = stats.blocksFound || 0;
                document.getElementById('status').textContent = 'Online';
                document.getElementById('statusIndicator').className = 'status-indicator status-online';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Update network info
                document.getElementById('blockHeight').textContent = stats.currentBlockHeight.toLocaleString();
                document.getElementById('networkDifficulty').textContent = this.formatDifficulty(stats.networkDifficulty);
                
                // Calculate and update hashrate
                const hashrate = parseFloat(stats.estimatedHashrate) || 0;
                console.log('Frontend: Using API hashrate:', hashrate, 'TH/s');
                document.getElementById('totalHashrate').textContent = `${hashrate} TH/s`;
                
                // Update efficiency bar
                this.updateEfficiencyBar(stats.efficiency);
                
                // Update performance metrics
                document.getElementById('avgProcessingTime').textContent = `${(stats.avgProcessingTime || 0).toFixed(1)}ms`;
                
                // Calculate shares per minute (rough estimate)
                const sharesPerMin = stats.sharesLastHour > 0 ? (stats.sharesLastHour / 60).toFixed(1) : '0.0';
                document.getElementById('sharesPerMinute').textContent = sharesPerMin;
                document.getElementById('rejectionRate').textContent = data.stats.rejectionRate + '%';

                
                // Update miners list
                this.updateMinersList(data.miners);
                
                // Update activity log
                this.updateActivityLog(data.recentActivity || []);
                
                // Store for comparison
                this.previousData = data;
                
                // Update charts
                this.updateCharts(data);
            }
            
            formatDifficulty(difficulty) {
                if (difficulty > 1e12) {
                    return (difficulty / 1e12).toFixed(2) + 'T';
                } else if (difficulty > 1e9) {
                    return (difficulty / 1e9).toFixed(2) + 'B';
                } else if (difficulty > 1e6) {
                    return (difficulty / 1e6).toFixed(2) + 'M';
                }
                return difficulty.toLocaleString();
            }
            
            updateMinersList(miners) {
                const minersList = document.getElementById('minersList');
                
                if (miners.length === 0) {
                    minersList.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">No miners connected</div>';
                    return;
                }
                
                minersList.innerHTML = miners.map(miner => {
                    const efficiency = miner.total_shares > 0 ? 
                        ((miner.valid_shares / miner.total_shares) * 100).toFixed(1) : '0.0';
                    const connectTime = new Date(miner.connected_at).toLocaleString();
                    const isLowEfficiency = parseFloat(efficiency) < 85;
                    
                    return `
                        <div class="miner-details">
                            <div class="miner-header">
                                <strong>${miner.username || 'Unknown'}</strong>
                                <span class="status-indicator ${miner.is_connected ? 'status-online' : 'status-offline'}"></span>
                            </div>
                            <div class="miner-stats">
                                <div>IP: ${miner.ip_address}</div>
                                <div>Connected: ${connectTime}</div>
                                <div class="${isLowEfficiency ? 'low-efficiency' : ''}">
                                    Efficiency: ${efficiency}%
                                </div>
                                <div>Shares: ${miner.valid_shares}/${miner.total_shares}</div>
                                <div class="hashrate-indicator">~14.0 TH/s</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateActivityLog(activities) {
                const activityLog = document.getElementById('activityLog');
                
                if (activities.length === 0) {
                    activityLog.innerHTML = '<div class="activity-item">No recent activity</div>';
                    return;
                }
                
                activityLog.innerHTML = activities.map(activity => {
                    const time = new Date(activity.submitted_at).toLocaleTimeString();
                    const icon = activity.meets_network_difficulty ? 'üíé' : 
                                activity.is_valid ? '‚úÖ' : '‚ùå';
                    const status = activity.meets_network_difficulty ? 'BLOCK FOUND!' :
                                  activity.is_valid ? 'Valid share' : 'Invalid share';
                    
                    return `
                        <div class="activity-item ${activity.meets_network_difficulty ? 'block-found' : ''}">
                            <div>${icon} ${status} from ${activity.username}</div>
                            <div class="activity-time">${time} - Nonce: ${activity.nonce} (${activity.processing_time_ms}ms)</div>
                        </div>
                    `;
                }).join('');
            }
            
            initCharts() {
                // Initialize chart canvases - you could integrate Chart.js here
                // For now, we'll create simple placeholder visualizations
                this.drawPlaceholderChart('hashrateChart', 'Hashrate over time');
                this.drawPlaceholderChart('shareChart', 'Share distribution');
            }
            
            drawPlaceholderChart(canvasId, title) {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = 'rgba(30, 60, 114, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                if (canvasId === 'hashrateChart') {
                    // Simple hashrate visualization
                    this.drawSimpleHashrateChart(ctx, canvas);
                } else if (canvasId === 'shareChart') {
                    // Simple share distribution
                    this.drawSimpleShareChart(ctx, canvas);
                }
            }
            
            drawSimpleHashrateChart(ctx, canvas) {
                const hashrate = parseFloat(document.getElementById('totalHashrate').textContent) || 0;
                const maxHashrate = 100; // TH/s scale
                
                // Draw simple bar
                const barHeight = (hashrate / maxHashrate) * (canvas.height - 60);
                ctx.fillStyle = '#f7931a';
                ctx.fillRect(50, canvas.height - barHeight - 30, 50, barHeight);
                
                // Labels
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`${hashrate} TH/s`, 50, canvas.height - 10);
                ctx.fillText('Current Hashrate', 10, 20);
            }

            drawSimpleShareChart(ctx, canvas) {
                const validShares = parseInt(document.getElementById('validShares').textContent) || 0;
                const totalShares = parseInt(document.getElementById('totalShares').textContent) || 0;
                const rejectedShares = totalShares - validShares;
                
                if (totalShares > 0) {
                    // Simple pie chart
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const radius = 60;
                    
                    const validAngle = (validShares / totalShares) * 2 * Math.PI;
                    
                    // Valid shares (green)
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, validAngle);
                    ctx.lineTo(centerX, centerY);
                    ctx.fillStyle = '#10b981';
                    ctx.fill();
                    
                    // Rejected shares (red)
                    if (rejectedShares > 0) {
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, validAngle, 2 * Math.PI);
                        ctx.lineTo(centerX, centerY);
                        ctx.fillStyle = '#ef4444';
                        ctx.fill();
                    }
                    
                    // Labels
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(`Valid: ${validShares}`, 10, 20);
                    ctx.fillText(`Rejected: ${rejectedShares}`, 10, 35);
                }
            }

            updateCharts(data) {
                // Store data for chart updates
                this.hashrateHistory.push({
                    time: Date.now(),
                    hashrate: this.calculateHashrate(data.miners)
                });
                
                this.shareHistory.push({
                    time: Date.now(),
                    valid: data.stats.validShares,
                    total: data.stats.totalShares
                });
                
                // Keep only last 24 hours of data
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                this.hashrateHistory = this.hashrateHistory.filter(point => point.time > oneDayAgo);
                this.shareHistory = this.shareHistory.filter(point => point.time > oneDayAgo);
                
                // Update charts (implement with Chart.js or similar)
                this.redrawCharts();
            }
            
            redrawCharts() {
                // Implement actual chart updates here
                // This is where you'd use Chart.js to create real-time charts
            }
            
            async startUpdating() {
                // Initial load
                const data = await this.fetchStats();
                this.updateDashboard(data);
                
                // Update every 3 seconds
                setInterval(async () => {
                    const data = await this.fetchStats();
                    this.updateDashboard(data);
                }, 3000);
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MiningDashboard();
        });
        // Add this at the end of updateDashboard function:
        if (data.timeWindows) {
            const windows = ['30m', '1h', '6h', '12h', '24h'];
            
            windows.forEach(window => {
                const efficiency = parseFloat(data.timeWindows[`efficiency_${window}`]);
                const efficiencyElement = document.getElementById(`efficiency${window}`);
                
                if (efficiencyElement) {
                    efficiencyElement.textContent = efficiency.toFixed(1) + '%';
                    
                    // Color coding
                    if (efficiency >= 95) {
                        efficiencyElement.className = 'window-efficiency efficiency-excellent';
                    } else if (efficiency >= 85) {
                        efficiencyElement.className = 'window-efficiency efficiency-good';
                    } else {
                        efficiencyElement.className = 'window-efficiency efficiency-poor';
                    }
                }
                
                const validElement = document.getElementById(`valid${window}`);
                const totalElement = document.getElementById(`total${window}`);
                
                if (validElement) validElement.textContent = data.timeWindows[`valid_${window}`];
                if (totalElement) totalElement.textContent = data.timeWindows[`shares_${window}`];
            });
        }
    </script>
</body>
</html>